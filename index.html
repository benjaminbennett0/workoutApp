<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <title>Workout Timer OS - V2.0.9r</title>
    <style>
        body { 
            margin: 0; background: #000; color: white; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            overflow: hidden; height: 100vh; width: 100vw;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            user-select: none; -webkit-user-select: none;
            padding: 0; 
            box-sizing: border-box;
            background-image: linear-gradient(#333, #333), linear-gradient(#333, #333);
            background-size: 100% 1px, 100% 1px;
            background-position: 0 15vh, 0 85vh;
            background-repeat: no-repeat;
        }

        .safe-zone { height: 15vh; width: 100%; display: flex; align-items: center; justify-content: center; z-index: 5; pointer-events: none; }
        
        /* Fixed Active Zone: Ensure it captures all clicks */
        #active-zone { 
            height: 70vh; 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            z-index: 10; 
            position: relative;
            background: rgba(0,0,0,0.01); /* Necessary for some browsers to detect touch */
        }

        .hud-display { font-variant-numeric: tabular-nums; font-size: clamp(1rem, 8vh, 10vw); color: #ffffff; font-weight: 300; }
        
        #timer-display { 
            font-variant-numeric: tabular-nums; 
            display: flex; 
            align-items: baseline; 
            transition: color 0.3s ease; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            pointer-events: none; 
        }

        #main-time { font-family: system-ui, -apple-system, sans-serif; font-size: clamp(5rem, 45vh, 75vw); font-weight: 700; line-height: 1; letter-spacing: -2px; }
        #ms-time { font-size: clamp(1.5rem, 12vh, 15vw); margin-left: 10px; opacity: 0.7; font-weight: 300; }
        
        .rest-mode { color: #3498db; }
        .lift-mode { color: #ffffff; }

        #version-tag { position: fixed; bottom: 5px; right: 10px; font-size: 10px; color: #ffffff; opacity: 0.3; z-index: 100; }
    </style>
</head>
<body id="body">
    <div id="version-tag">V2.0.9r</div>

    <div class="safe-zone"><div id="clock" class="hud-display">00:00:00</div></div>

    <div id="active-zone">
        <div id="timer-display" class="lift-mode">
            <span id="main-time">00:00</span><span id="ms-time">.0</span>
        </div>
    </div>

    <div class="safe-zone"><div id="session-timer" class="hud-display">0:00:00</div></div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            window.location.reload();
                        }
                    };
                };
            });
        }

        let restDuration = 25; 
        let buzzerDuration = 3.0, buzzerOffset = -0.3;
        let startTime = 0, sessionStartTime = 0, elapsed = 0, timerInterval = null;
        let isRunning = false, isRestPhase = false, audioTriggered = false, pressTimer = null, wakeLock = null;
        let audioCtx;

        const clockDisplay = document.getElementById('clock'), sessionDisplay = document.getElementById('session-timer');
        const mainDisplay = document.getElementById('main-time'), msDisplay = document.getElementById('ms-time');
        const timerContainer = document.getElementById('timer-display'), activeZone = document.getElementById('active-zone');

        async function requestWakeLock() {
            if (!('wakeLock' in navigator)) return;
            try {
                wakeLock = await navigator.wakeLock.request('screen');
            } catch (err) {}
        }

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        async function engageSystems() {
            initAudio();
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
            if (screen.orientation && screen.orientation.lock) screen.orientation.lock('landscape').catch(() => {});
            if (!wakeLock) await requestWakeLock();
        }

        function playBuzzer(isFinal = false, isGhost = false, duration = 4.0, time = null) {
            initAudio();
            const now = time || audioCtx.currentTime;
            const peaks = isFinal ? [438, 874, 1743, 2663, 3490, 5328] : [220, 438, 874, 1743, 2662];
            const masterOut = audioCtx.createGain();
            masterOut.gain.setValueAtTime(0.2, now);
            masterOut.connect(audioCtx.destination);
            peaks.forEach((freq) => {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.frequency.setValueAtTime(freq, now);
                g.gain.setValueAtTime(isGhost ? 0.04 : 0.5, now);
                g.gain.setValueAtTime(0, now + (isGhost ? duration : 0.5));
                osc.connect(g); g.connect(masterOut);
                osc.start(now); osc.stop(now + duration + 0.1);
            });
        }

        function startTimer() {
            initAudio();
            const now = performance.now();
            startTime = now; sessionStartTime = now;
            isRunning = true; isRestPhase = true; audioTriggered = false;
            if (timerInterval) cancelAnimationFrame(timerInterval);
            timerInterval = requestAnimationFrame(updateClock);
        }

        function resetTimer() { 
            startTime = performance.now(); 
            isRestPhase = true; 
            audioTriggered = false; 
        }

        function updateClock(now) {
            if (!isRunning) return;
            clockDisplay.innerText = new Date().toLocaleTimeString([], { hour12: true, hour: 'numeric', minute: '2-digit', second: '2-digit' });
            const sE = Math.floor((now - sessionStartTime) / 1000);
            sessionDisplay.innerText = `${Math.floor(sE / 3600)}:${Math.floor((sE % 3600) / 60).toString().padStart(2, '0')}:${(sE % 60).toString().padStart(2, '0')}`;
            elapsed = now - startTime;
            let totalSeconds = elapsed / 1000;
            if (isRestPhase && totalSeconds >= restDuration) isRestPhase = false;
            if (isRestPhase && !audioTriggered && totalSeconds >= (restDuration - buzzerDuration + buzzerOffset)) {
                audioTriggered = true;
                const sync = audioCtx.currentTime;
                playBuzzer(false, true, 4.0, sync);
                playBuzzer(false, false, 0.5, sync);
                playBuzzer(false, false, 0.5, sync + 1.0);
                playBuzzer(false, false, 0.5, sync + 2.0);
                playBuzzer(true, false, 1.0, sync + 3.0);
            }
            renderMainTimer(elapsed);
            timerContainer.className = isRestPhase ? 'rest-mode' : 'lift-mode';
            timerInterval = requestAnimationFrame(updateClock);
        }

        function renderMainTimer(ms) {
            let ts = Math.floor(ms / 1000);
            mainDisplay.innerText = `${Math.floor(ts / 60).toString().padStart(2, '0')}:${(ts % 60).toString().padStart(2, '0')}`;
            msDisplay.innerText = `.${Math.floor((ms % 1000) / 100)}`;
        }

        // Consolidated Input Logic
        function handleInteractionStart() {
            engageSystems();
            pressTimer = setTimeout(() => {
                isRestPhase = false;
                audioTriggered = true;
                pressTimer = null;
            }, 500);
        }

        function handleInteractionEnd() {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
                if (!isRunning) startTimer();
                else resetTimer();
            }
        }

        activeZone.addEventListener('mousedown', handleInteractionStart);
        window.addEventListener('mouseup', handleInteractionEnd);
        activeZone.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleInteractionStart();
        }, {passive: false});
        window.addEventListener('touchend', handleInteractionEnd);

        document.addEventListener('visibilitychange', () => { 
            if (document.visibilityState === 'visible') { 
                requestWakeLock();
                if (isRunning) startTime = performance.now() - elapsed; 
            } 
        });
    </script>
</body>
</html>
