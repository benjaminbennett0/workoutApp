<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Workout Timer OS - Supersets</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1DB954">

    <style>
        body { 
            margin: 0; 
            background: #000; 
            color: white; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw; 
        }
        
        /* Top Music Bar */
        #music-zone { 
            height: 15vh; 
            border-bottom: 2px solid #333; 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #progress-bar { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            height: 4px; 
            background: #1DB954; 
            width: 40%; 
        }

        /* Main Workout Zone - Horizontal Flex for Landscape */
        #workout-zone { 
            height: 85vh; 
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            justify-content: space-evenly; 
        }

        .superset-box {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        /* Divider / Timer Section */
        #timer-container {
            width: 20vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
            height: 60%;
        }
        
        #timer { font-size: 8vw; font-weight: bold; line-height: 1; }
        
        /* Typography */
        .activity-label { font-size: 1.2vw; color: #1DB954; letter-spacing: 2px; margin-bottom: 5px; }
        .exercise-name { font-size: 3.5vw; font-weight: bold; margin: 10px 0; line-height: 1.1; }
        .exercise-stats { font-size: 2.5vw; color: #aaa; }

        /* Selection Screen */
        #selection-overlay { 
            position: fixed; 
            inset: 0; 
            background: black; 
            display: flex; 
            gap: 20px; 
            align-items: center; 
            justify-content: center; 
            z-index: 10; 
        }
        .routine-btn { 
            padding: 40px; 
            font-size: 2rem; 
            background: #222; 
            border: 2px solid white; 
            color: white; 
            border-radius: 15px; 
            cursor: pointer;
        }

        /* Fullscreen Toggle Button */
        #fs-btn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #555;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 5;
        }

        /* Wake Lock Status Indicator (Subtle) */
        #wake-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 10px;
            color: #333;
            z-index: 5;
        }
    </style>
</head>
<body>

    <div id="selection-overlay">
        <button class="routine-btn" onclick="startRoutine('upper')">Upper Body</button>
        <button class="routine-btn" onclick="startRoutine('lower')">Lower Body</button>
    </div>

    <div id="music-zone" onclick="handleMusicTap(event)">
        <div id="song-display"><strong>Song Title</strong> - Artist Name</div>
        <div id="progress-bar"></div>
    </div>

    <div id="workout-zone" onclick="handleWorkoutTap(event)">
        <div class="superset-box" id="box-a">
            <div class="activity-label">EXERCISE A</div>
            <div class="exercise-name" id="name-a">--</div>
            <div class="exercise-stats" id="stats-a">--</div>
        </div>

        <div id="timer-container">
            <div class="activity-label" id="timer-label">REST</div>
            <div id="timer">00:00</div>
        </div>

        <div class="superset-box" id="box-b">
            <div class="activity-label">EXERCISE B</div>
            <div class="exercise-name" id="name-b">--</div>
            <div class="exercise-stats" id="stats-b">--</div>
        </div>
    </div>

    <div id="wake-status">SCREEN LOCK: INACTIVE</div>
    <button id="fs-btn" onclick="toggleFullscreen()">â›¶ FULLSCREEN</button>

    <script>
        let workoutData = [];
        let currentIndex = 0;
        let isRunning = false;
        let timerInterval;
        let seconds = 0;
        let wakeLock = null;

        // FIXED CSV URL
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQmrKfGKM6t61M-jDPlPcClxpoewbXNUWoaKoPzdEGdLEFdlvvCM-y456r46CYkh1YXEV-KvmEuWP7o/pub?gid=0&single=true&output=csv";

        // --- SCREEN WAKE LOCK LOGIC ---
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    document.getElementById('wake-status').innerText = "SCREEN LOCK: ACTIVE";
                    document.getElementById('wake-status').style.color = "#1DB954";
                    
                    wakeLock.addEventListener('release', () => {
                        document.getElementById('wake-status').innerText = "SCREEN LOCK: INACTIVE";
                        document.getElementById('wake-status').style.color = "#333";
                    });
                }
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }

        // Re-acquire lock when app comes back to foreground
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        async function startRoutine(type) {
            const overlay = document.getElementById('selection-overlay');
            overlay.innerHTML = "<h1>Loading " + type + "...</h1>";

            // Request Wake Lock as soon as the workout starts
            await requestWakeLock();

            try {
                const response = await fetch(CSV_URL);
                const data = await response.text();
                const rows = data.split('\n').map(row => row.split(',').map(cell => cell.replace('\r', '').trim()));
                
                workoutData = rows.slice(1).filter(row => {
                    return row[0] && row[0].toLowerCase() === type;
                });
                
                if (workoutData.length === 0) {
                    alert("No exercises found for: " + type);
                    location.reload();
                    return;
                }

                overlay.style.display = 'none';
                currentIndex = 0;
                displayExercise();
            } catch (err) {
                alert("Error loading sheet: " + err);
                location.reload();
            }
        }

        function displayExercise() {
            const exA = workoutData[currentIndex];
            const exB = workoutData[currentIndex + 1];

            if (exA) {
                document.getElementById('name-a').innerText = exA[1].toUpperCase();
                document.getElementById('stats-a').innerText = `${exA[2]} x ${exA[3]}`;
            }

            if (exB) {
                document.getElementById('name-b').innerText = exB[1].toUpperCase();
                document.getElementById('stats-b').innerText = `${exB[2]} x ${exB[3]}`;
                document.getElementById('box-b').style.opacity = "1";
            } else {
                document.getElementById('name-b').innerText = "SINGLE SET";
                document.getElementById('stats-b').innerText = "";
                document.getElementById('box-b').style.opacity = "0.3";
            }

            resetTimer();
        }

        function handleWorkoutTap(e) {
            const isLeft = e.clientX < window.innerWidth / 2;
            
            if (isLeft) {
                if (currentIndex >= 2) {
                    currentIndex -= 2;
                    displayExercise();
                }
            } else {
                if (!isRunning && seconds === 0) {
                    startTimer();
                } else {
                    nextActivity();
                }
            }
        }

        function startTimer() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('timer').style.color = '#1DB954';
            document.getElementById('timer-label').innerText = "RUNNING";
            
            timerInterval = setInterval(() => {
                seconds++;
                let mins = Math.floor(seconds / 60);
                let secs = seconds % 60;
                document.getElementById('timer').innerText = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function nextActivity() {
            if (currentIndex < workoutData.length - 2) {
                currentIndex += 2;
                displayExercise();
            } else {
                alert("Workout Complete!");
                location.reload();
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            seconds = 0;
            document.getElementById('timer').innerText = "00:00";
            document.getElementById('timer').style.color = 'white';
            document.getElementById('timer-label').innerText = "REST";
        }

        function handleMusicTap(e) {
            console.log("Music Tap");
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>
