<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Workout Timer OS - V1.0.6</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1DB954">

    <style>
        body { 
            margin: 0; 
            background: #000; 
            color: white; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw; 
        }
        
        #music-zone { 
            height: 15vh; 
            border-bottom: 2px solid #333; 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        #workout-zone { 
            height: 85vh; 
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            justify-content: space-evenly; 
        }

        .superset-box {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        #timer-container {
            width: 20vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
            height: 60%;
        }
        
        #timer { font-size: 8vw; font-weight: bold; line-height: 1; }
        .activity-label { font-size: 1.2vw; color: #1DB954; letter-spacing: 2px; margin-bottom: 5px; }
        .exercise-name { font-size: 3.5vw; font-weight: bold; margin: 10px 0; line-height: 1.1; }
        .exercise-stats { font-size: 2.5vw; color: #aaa; }

        #selection-overlay { 
            position: fixed; 
            inset: 0; 
            background: black; 
            display: flex; 
            flex-direction: column;
            gap: 20px; 
            align-items: center; 
            justify-content: center; 
            z-index: 10; 
        }
        .routine-btn { 
            padding: 40px; 
            font-size: 2rem; 
            background: #222; 
            border: 2px solid white; 
            color: white; 
            border-radius: 15px; 
            cursor: pointer;
            width: 300px;
        }

        /* NEW VERSION TAG POSITION */
        #version-tag {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #1DB954;
            font-size: 18px;
            font-weight: bold;
            background: rgba(29, 185, 84, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #1DB954;
        }

        #wake-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 10px;
            color: #333;
            z-index: 5;
        }
    </style>
</head>
<body>

    <div id="selection-overlay">
        <div id="version-tag">STABLE V1.0.6</div>
        <button class="routine-btn" onclick="startRoutine('upper')">Upper Body</button>
        <button class="routine-btn" onclick="startRoutine('lower')">Lower Body</button>
    </div>

    <div id="music-zone">
        <div id="song-display"><strong>Workout Timer</strong></div>
    </div>

    <div id="workout-zone" onclick="handleWorkoutTap(event)">
        <div class="superset-box" id="box-a">
            <div class="activity-label">EXERCISE A</div>
            <div class="exercise-name" id="name-a">--</div>
            <div class="exercise-stats" id="stats-a">--</div>
        </div>
        <div id="timer-container">
            <div class="activity-label" id="timer-label">REST</div>
            <div id="timer">00:00</div>
        </div>
        <div class="superset-box" id="box-b">
            <div class="activity-label">EXERCISE B</div>
            <div class="exercise-name" id="name-b">--</div>
            <div class="exercise-stats" id="stats-b">--</div>
        </div>
    </div>

    <div id="wake-status">SCREEN LOCK: INACTIVE</div>

    <script>
        const VERSION = "1.0.6";
        let workoutData = [];
        let currentIndex = 0;
        let isRunning = false;
        let timerInterval;
        let seconds = 0;
        let wakeLock = null;

        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQmrKfGKM6t61M-jDPlPcClxpoewbXNUWoaKoPzdEGdLEFdlvvCM-y456r46CYkh1YXEV-KvmEuWP7o/pub?gid=0&single=true&output=csv";

        async function requestWakeLock() {
            if (!('wakeLock' in navigator)) return;
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                document.getElementById('wake-status').innerText = "SCREEN LOCK: ACTIVE";
                document.getElementById('wake-status').style.color = "#1DB954";
            } catch (err) { console.warn("Wake Lock fail"); }
        }

        async function startRoutine(type) {
            const overlay = document.getElementById('selection-overlay');
            overlay.innerHTML = `<h1>Connecting...</h1><p style="color:#1DB954">Ver ${VERSION}</p>`;

            try {
                requestWakeLock();
                const response = await fetch(`${CSV_URL}&cb=${new Date().getTime()}`);
                const rawText = await response.text();
                const rows = rawText.split(/\r?\n|\r/).map(row => row.split(',').map(cell => cell.trim()));

                workoutData = rows.slice(1).filter(row => row[0] && row[0].toLowerCase() === type.toLowerCase());

                if (workoutData.length === 0) throw new Error("No exercises found");

                overlay.style.display = 'none';
                displayExercise();
            } catch (err) {
                alert("Error: " + err.message);
                location.reload();
            }
        }

        function displayExercise() {
            const exA = workoutData[currentIndex];
            const exB = workoutData[currentIndex + 1];
            if (exA) {
                document.getElementById('name-a').innerText = exA[1].toUpperCase();
                document.getElementById('stats-a').innerText = `${exA[2]} x ${exA[3]}`;
            }
            if (exB) {
                document.getElementById('name-b').innerText = exB[1].toUpperCase();
                document.getElementById('stats-b').innerText = `${exB[2]} x ${exB[3]}`;
                document.getElementById('box-b').style.opacity = "1";
            } else {
                document.getElementById('name-b').innerText = "FINISH";
                document.getElementById('box-b').style.opacity = "0.3";
            }
            resetTimer();
        }

        function handleWorkoutTap(e) {
            const isLeft = e.clientX < window.innerWidth / 2;
            if (isLeft) {
                if (currentIndex >= 2) { currentIndex -= 2; displayExercise(); }
            } else {
                if (!isRunning && seconds === 0) { startTimer(); } 
                else { nextActivity(); }
            }
        }

        function startTimer() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('timer').style.color = '#1DB954';
            timerInterval = setInterval(() => {
                seconds++;
                let mins = Math.floor(seconds / 60);
                let secs = seconds % 60;
                document.getElementById('timer').innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function nextActivity() {
            if (currentIndex < workoutData.length - 2) {
                currentIndex += 2;
                displayExercise();
            } else {
                alert("Workout Complete!");
                location.reload();
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            seconds = 0;
            document.getElementById('timer').innerText = "00:00";
            document.getElementById('timer').style.color = 'white';
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { 
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                location.reload();
                            }
                        };
                    };
                });
            });
        }
    </script>
</body>
</html>
