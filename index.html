<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcade Workout Timer - V1.5.6</title>
    <style>
        :root { --primary: #1DB954; --bg: #000; --card: #111; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .container { background: var(--card); padding: 40px; border-radius: 30px; border: 2px solid var(--primary); text-align: center; width: 350px; box-shadow: 0 0 20px rgba(29, 185, 84, 0.2); }
        .timer-display { font-size: 6rem; font-weight: bold; margin: 10px 0; font-variant-numeric: tabular-nums; color: var(--primary); }
        .label { text-transform: uppercase; letter-spacing: 2px; color: #888; font-size: 0.9rem; margin-bottom: 5px; }
        .workout-name { font-size: 1.5rem; color: #fff; margin-bottom: 20px; font-weight: 600; min-height: 1.8em; }
        .controls { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        button { padding: 20px; border-radius: 15px; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.2s; text-transform: uppercase; }
        #startBtn { background: var(--primary); color: #000; }
        #resetBtn { background: transparent; color: #555; font-size: 0.8rem; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #333; margin-right: 5px; }
        .active-dot { background: var(--primary); box-shadow: 0 0 5px var(--primary); }
    </style>
</head>
<body>

    <div class="container">
        <div id="connectionStatus" style="font-size: 0.7rem; color: #444; margin-bottom: 20px;">
            <span class="status-dot" id="dot"></span> SHEETS LINKED
        </div>
        <div class="label" id="phaseLabel">GET READY</div>
        <div class="workout-name" id="workoutName">Loading...</div>
        <div class="timer-display" id="display">00:00</div>
        
        <div class="controls">
            <button id="startBtn" onclick="handleStartClick()">START SESSION</button>
            <button id="resetBtn" onclick="resetTimer()">RESET SYSTEM</button>
        </div>
    </div>

<script>
    // --- GOOGLE SHEET CONFIGURATION ---
    const SHEET_ID = 'YOUR_SHEET_ID_HERE'; // Replace with your actual ID
    const TAB_NAME = 'Sheet1';
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${TAB_NAME}`;

    // --- AUDIO CALIBRATION (V1.5.6) ---
    const BEEP_PEAKS = [220, 438, 874, 1743, 2662];
    const GO_PEAKS   = [438, 874, 1743, 2663, 3490, 5328];
    const VOL_MIX    = [1.0, 0.8, 0.5, 0.4, 0.3, 0.4]; 
    const GHOST_VOL  = 0.10;
    const GO_FADE_S  = 0.9;
    const GO_FADE_TO = 0.5;

    let audioCtx;
    let timerInterval;
    let timeLeft = 0;
    let isRunning = false;
    let workoutData = [];

    // --- AUDIO ENGINE ---
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        document.getElementById('dot').classList.add('active-dot');
    }

    function playBuzzer(isFinal = false, isGhost = false, customDuration = 4.0) {
        initAudio();
        const now = audioCtx.currentTime;
        const duration = isFinal ? 1.0 : 0.5;
        const peaks = isFinal ? GO_PEAKS : BEEP_PEAKS;
        const masterOut = audioCtx.createGain();
        masterOut.gain.setValueAtTime(0.2, now);
        masterOut.connect(audioCtx.destination);

        peaks.forEach((freq, index) => {
            const osc = audioCtx.createOscillator();
            const oscGain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, now);
            let peakVol = (isFinal && index >= 4) ? VOL_MIX[5] : VOL_MIX[index];

            if (isGhost) {
                oscGain.gain.setValueAtTime(0, now);
                oscGain.gain.linearRampToValueAtTime(peakVol * GHOST_VOL, now + 0.05);
                oscGain.gain.setValueAtTime(peakVol * GHOST_VOL, now + customDuration);
                oscGain.gain.setValueAtTime(0, now + customDuration + 0.001);
            } else if (isFinal) {
                oscGain.gain.setValueAtTime(peakVol, now);
                oscGain.gain.setValueAtTime(peakVol, now + GO_FADE_S);
                oscGain.gain.linearRampToValueAtTime(peakVol * GO_FADE_TO, now + duration);
                oscGain.gain.setValueAtTime(0, now + duration + 0.001);
            } else {
                oscGain.gain.setValueAtTime(peakVol, now);
                oscGain.gain.setValueAtTime(0, now + duration);
            }
            osc.connect(oscGain);
            oscGain.connect(masterOut);
            osc.start();
            osc.stop(now + (isGhost ? customDuration : duration) + 0.1);
        });
    }

    // --- DATA FETCHING ---
    async function fetchWorkout() {
        try {
            const response = await fetch(CSV_URL);
            const data = await response.text();
            const rows = data.split('\n').slice(1); 
            workoutData = rows.map(row => {
                const columns = row.split(',');
                return {
                    name: columns[0].replace(/"/g, ''),
                    duration: parseInt(columns[1])
                };
            });
            if (workoutData.length > 0) {
                timeLeft = workoutData[0].duration;
                document.getElementById('workoutName').innerText = workoutData[0].name;
                updateDisplay();
            }
        } catch (error) {
            document.getElementById('workoutName').innerText = "Sheet Error";
        }
    }

    // --- TIMER LOGIC ---
    function handleStartClick() {
        initAudio();
        if (isRunning) {
            pauseTimer();
        } else {
            runArcadeCountdown();
        }
    }

    function runArcadeCountdown() {
        document.getElementById('phaseLabel').innerText = "GET SET";
        document.getElementById('startBtn').disabled = true;
        
        playBuzzer(false, true, 4.0); // Ghost starts
        playBuzzer(false, false);      // 3
        setTimeout(() => playBuzzer(false, false), 1000); // 2
        setTimeout(() => playBuzzer(false, false), 2000); // 1
        
        setTimeout(() => {
            playBuzzer(true, false); // GO!
            document.getElementById('phaseLabel').innerText = "WORKOUT ACTIVE";
            document.getElementById('startBtn').disabled = false;
            startTimer();
        }, 3000);
    }

    function startTimer() {
        isRunning = true;
        document.getElementById('startBtn').innerText = "PAUSE";
        timerInterval = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                document.getElementById('phaseLabel').innerText = "COMPLETE";
                isRunning = false;
                // Add logic here if you want it to jump to the next Sheet row automatically
            }
        }, 1000);
    }

    function pauseTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        document.getElementById('startBtn').innerText = "RESUME";
        document.getElementById('phaseLabel').innerText = "PAUSED";
    }

    function updateDisplay() {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        document.getElementById('display').innerText = 
            `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function resetTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        fetchWorkout();
        document.getElementById('startBtn').innerText = "START SESSION";
        document.getElementById('phaseLabel').innerText = "GET READY";
    }

    // Auto-load data on startup
    fetchWorkout();
    document.addEventListener('touchstart', initAudio, {once: true});
</script>
</body>
</html>
